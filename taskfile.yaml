version: "3"

tasks:
  prepare-metrics:
    dir: ".scratch-metrics"
    cmds:
      - git clone https://github.com/VictoriaMetrics/metricsql.git metricsql
      - cd metricsql && git reset --hard a271ee257023dd183d444ec7e1b363c64a3db0e3
      - cd metricsql && git apply ../../metrics.patch
      - mkdir -p metricsql/main
      - |
        cat << EOF > metricsql/main/main.go
        package main

        import (
          "github.com/VictoriaMetrics/metricsql"
          "syscall/js"
        )

        func main() {
          c := make(chan struct{}, 0)
          js.Global().Set("prettify", js.FuncOf(PrettifyWrap))
          <-c
        }

        func PrettifyWrap(this js.Value, inputs []js.Value) interface{} {
          prettify, err := metricsql.Prettify(inputs[0].String())
          if err != nil {
            return nil
          }
          return prettify
        }
        EOF

  build-metrics:
    dir: ".scratch-metrics/metricsql"
    cmds:
      - task: prepare-metrics
      - GOOS=js GOARCH=wasm go build -o ../../public/metricsql.wasm main/main.go

  clean-metrics:
    cmds:
      - rm -rf .scratch-metrics

  build-vite:
    cmds:
      - npm run build

  clean-vite:
    cmds:
      - rm -r dist

  build:
    cmds:
      - task: build-metrics
      - task: build-vite

  clean:
    deps:
      - clean-metrics
      - clean-vite
